name: Emergency Debug
on:
  workflow_dispatch:

jobs:
  debug_job:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Run and Save
        env:
          # כאן אנחנו משתמשים ב-Secret המאוחד שיצרת
          MONEYMAN_CONFIG: ${{ secrets.MONEYMAN_CONFIG }}
        run: |
          echo "--- LOG START ---" > results.txt
          echo "Time: $(date)" >> results.txt
          
          npm install >> results.txt 2>&1
          
          echo "Starting Scrape Execution..." >> results.txt
          # מריצים ושולחים את כל הפלט (גם שגיאות) לקובץ
          npx tsx src/index.ts scrape >> results.txt 2>&1 || echo "Process exited with error" >> results.txt
          
          echo "--- LOG END ---" >> results.txt

      - name: Push Results
        run: |
          git config --global user.name "Debug Bot"
          git config --global user.email "bot@debug.com"
          git add results.txt
          git commit -m "Updated debug results" || exit 0
          git push
